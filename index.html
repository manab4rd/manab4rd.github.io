<!DOCTYPE html>
<html ng-app="quizApp">
<head>
  <meta charset="utf-8" />
  <title>Edison In You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
  <script src="https://html2canvas.hertzen.com/build/html2canvas.js"></script>

  <script src="build/tracking-min.js"></script>
  <script src="build/data/face-min.js"></script>
  <style>
  #video, #canvas {
    position: absolute;
    mask:url('#imask');
    -webkit-mask:url('edison-mask.png');
    margin:0 auto;
    max-width: 100%;
    right: 0;
    left: 0;
  }
.photo.card{width: 350px; margin: 0 auto;}
  </style>
</head>

<body>
  <div class="container">
    <script>
      window.onload = function() {
        var video = document.getElementById('video');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var clickcount = 1;
        var tracker = new tracking.ObjectTracker('face');
        tracker.setInitialScale(4);
        tracker.setStepSize(2);
        tracker.setEdgesDensity(0.1);


        tracking.track('#video', tracker, { camera: true });

        tracker.on('track', function(event) {
          context.clearRect(0, 0, canvas.width, canvas.height);

          event.data.forEach(function(rect) {
            context.strokeStyle = '#a64ceb';
            context.strokeRect(rect.x, rect.y, rect.width, rect.height);
            context.font = '11px Helvetica';
            context.fillStyle = "#fff";
            context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
            context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);

            if(rect.x >= 115 && rect.x <= 120 && rect.y >= 35 && rect.y <= 55  && clickcount == 1){
              $('.camerapanel').hide();
              $('.quizpanel').show();
              video.pause();
              var snap = new takePhoto(canvas.width, canvas.height);
              console.log(snap);
              clickcount ++;
            }
          });
        });

        var takePhoto = function(w,h){

          var hidden_canvas = document.querySelector('canvas'),
             context = hidden_canvas.getContext('2d');

         var width = w,
             height = h;

         if (width && height) {

           hidden_canvas.width = width;
           hidden_canvas.height = height;
           context.drawImage(video, 0, 0, width, height);

            var imgPixels = context.getImageData(0, 0, width, height);

            for(var y = 0; y < height; y++){
                for(var x = 0; x < width; x++){
                    var i = (y * 4) * width + x * 4;
                    var avg = (imgPixels.data[i] + imgPixels.data[i + 1] + imgPixels.data[i + 2]) / 3;
                    imgPixels.data[i] = avg;
                    imgPixels.data[i + 1] = avg;
                    imgPixels.data[i + 2] = avg;
                }
            }

            context.putImageData(imgPixels, 0, 0, 0, 0, imgPixels.width, imgPixels.height);

           var image = document.querySelector('#snap');
           image.setAttribute('src', hidden_canvas.toDataURL('image/png'));

         }
        }

      };
    </script>

  <div class="row justify-content-md-center">
    <div class="col-12 col-md-6 con-md-offset-3">
      <p class="display-4">See the Edison in you</p>
      <div class="camerapanel">
        <video id="video" width="350" height="257" preload autoplay loop muted></video>
        <canvas id="canvas" width="350" height="257"></canvas>
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 350 257">
                  <defs>
                      <mask id="imask" >
                          <image width="350" height="257" xlink:href="edison-mask.png"></image>
                      </mask>
                  </defs>
              </svg>
      </div>
      <div class="quizpanel" style="display:none;">
        <hr/>

        <quiz/>
      </div>
    </div>
   </div>

  </div>
  </body>

  </html>
