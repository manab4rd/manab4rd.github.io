<!DOCTYPE html>
<html ng-app="quizApp">
<head>
  <meta charset="utf-8" />
  <title>Edison In You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
  <script src="https://html2canvas.hertzen.com/build/html2canvas.js"></script>

  <!-- <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet"> -->
  <script src="app.js"></script>
  <script src="build/tracking-min.js"></script>
  <script src="build/data/face-min.js"></script>
  <style>
  #video, #canvas {
    /*margin-left: 350px;
    margin-top: 10px;*/
    position: absolute;
    mask:url('#imask');
    mask-repeat: no-repeat;
    mask-position: center;
    -webkit-mask:url('edison-mask.png');
    -webkit-mask-repeat: no-repeat;
    -webkit-mask-position: center;
    margin:0 auto;
    width: 350px;
    height: 257px;
    max-width: 100%;
    right: 0;
    left: 0;
  }
  /*#snap{filter: grayscale(90%);
-webkit-filter: grayscale(90%);
-moz-filter: grayscale(90%);
-ms-filter: grayscale(90%);
-o-filter: grayscale(90%);
filter: grayscale(0%);    background-position: center;
    background-size: 90%;}*/
.photo.card{width: 350px; margin: 0 auto;}
.list-unstyled li{ margin: 1em 0;}
/*.photo.card .card-body{font-family: 'Gloria Hallelujah', cursive;}*/
  </style>
</head>

<body>
  <div class="container">
    <script>
      window.onload = function() {
        var video = document.getElementById('video');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var clickcount = 1;
        var tracker = new tracking.ObjectTracker('face');
        tracker.setInitialScale(4);
        tracker.setStepSize(2);
        tracker.setEdgesDensity(0.1);
        //console.log("Video -- "+$('#video').width() + "/"+ $('#video').height());
        //console.log("Canvas -- "+canvas.width + "/"+ canvas.height);
        if( navigator.userAgent.match(/Android/i)
         || navigator.userAgent.match(/webOS/i)
         || navigator.userAgent.match(/iPhone/i)
         || navigator.userAgent.match(/iPad/i)
         || navigator.userAgent.match(/iPod/i)
         || navigator.userAgent.match(/BlackBerry/i)
         || navigator.userAgent.match(/Windows Phone/i)
         ){
            canvas.width = ($('#video').height()*2)/3;
            $('#video').attr('width',$('#video').width());
          }
         else {
            canvas.width = $('#video').width();
            $('#video').attr('width',$('#video').width());
          }
        $('#video').attr('height',$('#video').height());
        canvas.height = $('#video').height();
        //console.log("Canvas -- "+canvas.width + "/"+ canvas.height);
        tracking.track('#video', tracker, { camera: true });

        tracker.on('track', function(event) {

          context.clearRect(0, 0, canvas.width, canvas.height);

          event.data.forEach(function(rect) {
            context.strokeStyle = '#ff8800';
            context.strokeRect(rect.x, rect.y, rect.width, rect.height);
            context.font = '11px Helvetica';
            context.fillStyle = "#fff";
            context.fillText('x: ' + rect.x + 'px', rect.x, rect.y + 11);
            context.fillText('y: ' + rect.y + 'px', rect.x, rect.y + 22);
            var calccenter = $('#video').width()/2 - rect.width/2;
            context.fillText('xy: ' + calccenter + 'px', rect.x, rect.y + 33);
            //console.log((calccenter-5) +"/"+ (calccenter+5));
            if(rect.x >= (calccenter) && rect.x <= (calccenter+10) && rect.y >= 35 && rect.y <= 45 && rect.width < 130 && clickcount == 1){
              //console.log('Hit');
              //var video = document.querySelector('#video');
              $('.camerapanel').hide();
              //var stopping = new stopTrack();
              $('.quizpanel').show();
              video.pause();
              var snap = new takePhoto(canvas.width, canvas.height);
              //console.log(snap);
              clickcount ++;
            }
          });
        });

        var takePhoto = function(w,h){

          var hidden_canvas = document.querySelector('#canvas'),
             context = hidden_canvas.getContext('2d');
         var width = w,
             height = h;

         if (width && height) {

           // Setup a canvas with the same dimensions as the video.
           hidden_canvas.width = width;
           hidden_canvas.height = height;
           // Make a copy of the current frame in the video on the canvas.
           context.drawImage(video, 0, 0, width, height);

           // Turn the canvas image into a dataURL that can be used as a src for our photo.
           //console.log(hidden_canvas.toDataURL('image/png'));
           //var image = document.querySelector('#snap');
           //$('#snap').css('background-image', 'url('+ hidden_canvas.toDataURL("image/png")+')');


            var imgPixels = context.getImageData(0, 0, width, height);

            for(var y = 0; y < height; y++){
                for(var x = 0; x < width; x++){
                    var i = (y * 4) * width + x * 4;
                    var avg = (imgPixels.data[i] + imgPixels.data[i + 1] + imgPixels.data[i + 2]) / 3;
                    imgPixels.data[i] = avg;
                    imgPixels.data[i + 1] = avg;
                    imgPixels.data[i + 2] = avg;
                }
            }

            context.putImageData(imgPixels, 0, 0, 0, 0, imgPixels.width, imgPixels.height);


           var image = document.querySelector('#snap');
           image.setAttribute('src', hidden_canvas.toDataURL('image/png'));


           //var dataurl = hidden_canvas.toDataURL('image/png');
           //return dataurl;

         }
        }


      };
    </script>


	<div class="row justify-content-md-center">
		<div class="col-12 col-md-6 con-md-offset-3 text-center my-3">
      <h3>See the Edison in you</h3>
      <p>Please allow the application to access the camera</p>
      <div class="camerapanel">
        <video id="video" preload autoplay loop muted></video>
        <canvas id="canvas"></canvas>
        <div class="clear"></div>

      </div>
      <div class="quizpanel" style="display:none;">
  		  <hr/>

  			<quiz/>
      </div>
		</div>
	 </div>

  </div>
</body>

</html>
